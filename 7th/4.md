# Модифицированный эксперимент с INSERT вместо UPDATE (чтение фантомных строк)

## Цель эксперимента:
Продемонстрировать появление фантомных строк при уровне изоляции Read Committed, когда параллельная транзакция добавляет новые записи, удовлетворяющие условиям выборки.

## Шаг 1: Начальное состояние (оба терминала)
```sql
SELECT * FROM aircrafts_tmp WHERE range > 6000;
```
Результат:
```
aircraft_code |     model      | range
--------------+----------------+-------
773          | Boeing 777-300 | 11100
763          | Boeing 767-300 |  7900
319          | Airbus A319-100|  6700
(3 строки)
```

## Шаг 2: Параллельные транзакции

### Транзакция 1 (Терминал 1):
```sql
BEGIN;
-- Первая выборка
SELECT * FROM aircrafts_tmp WHERE range > 6000;
-- Получаем те же 3 строки
```

### Транзакция 2 (Терминал 2):
```sql
BEGIN;
-- Вставляем новый самолет с range > 6000
INSERT INTO aircrafts_tmp 
VALUES ('333', 'Airbus A330-300', 6500);
COMMIT; -- Фиксируем изменения сразу
```

## Шаг 3: Повторная выборка в Транзакции 1
```sql
-- В Терминале 1 (та же транзакция):
SELECT * FROM aircrafts_tmp WHERE range > 6000;
```
Новый результат:
```
aircraft_code |     model      | range
--------------+----------------+-------
773          | Boeing 777-300 | 11100
763          | Boeing 767-300 |  7900
319          | Airbus A319-100|  6700
333          | Airbus A330-300|  6500
(4 строки)
```

## Шаг 4: Завершение
```sql
COMMIT; -- В Терминале 1
```

## Объяснение феномена:

1. **Механизм фантомного чтения**:
   - Транзакция 1 видит новые строки, добавленные и зафиксированные параллельными транзакциями
   - В отличие от UPDATE, INSERT создает совершенно новые строки
   - На уровне Read Committed каждая новая выборка видит последние зафиксированные изменения

2. **Разница между UPDATE и INSERT**:
   - При UPDATE изменяются существующие строки
   - При INSERT добавляются новые строки, которые становятся видимыми для последующих запросов

3. **Почему это важно**:
   - Может нарушать логику приложений, рассчитывающих на стабильность данных в рамках транзакции
   - Особенно критично для отчетных систем и аналитических запросов

## Как избежать фантомного чтения:
1. Использовать более строгий уровень изоляции (Repeatable Read или Serializable)
2. Применять явные блокировки (`SELECT ... FOR UPDATE`)
3. Использовать материализованные представления для сложных отчетов

Этот эксперимент наглядно показывает, почему понимание уровней изоляции критически важно для разработчиков баз данных.
# Эксперименты с `FOR SHARE` в PostgreSQL

## Что такое `FOR SHARE`?

`FOR SHARE` — это модификатор команды `SELECT`, который устанавливает блокировку **совместного доступа (shared lock)** на выбранные строки. Это позволяет:
- Читать данные параллельным транзакциям
- Запрещать изменение или удаление этих строк другими транзакциями до завершения текущей

## Базовый синтаксис

```sql
SELECT * FROM table_name WHERE condition FOR SHARE [NOWAIT|SKIP LOCKED];
```

## Практические эксперименты

### Эксперимент 1: Базовое использование FOR SHARE

**Терминал 1:**
```sql
BEGIN;
SELECT * FROM aircrafts_tmp WHERE range > 6000 FOR SHARE;
-- Удерживает блокировку на 3 строки
```

**Терминал 2:**
```sql
BEGIN;
-- Может читать те же данные
SELECT * FROM aircrafts_tmp WHERE range > 6000;

-- Но не может обновить заблокированные строки
UPDATE aircrafts_tmp SET range = 6500 WHERE aircraft_code = '773';
-- Ожидает завершения транзакции в Терминале 1
```

### Эксперимент 2: NOWAIT вариант

**Терминал 1:**
```sql
BEGIN;
SELECT * FROM aircrafts_tmp WHERE range > 6000 FOR SHARE;
```

**Терминал 2:**
```sql
BEGIN;
SELECT * FROM aircrafts_tmp WHERE range > 6000 FOR SHARE NOWAIT;
-- Если строки уже заблокированы, сразу получим ошибку:
-- ERROR:  could not obtain lock on row in relation "aircrafts_tmp"
```

### Эксперимент 3: SKIP LOCKED вариант

**Терминал 1:**
```sql
BEGIN;
SELECT * FROM aircrafts_tmp WHERE range > 6000 FOR SHARE;
-- Блокирует 3 строки
```

**Терминал 2:**
```sql
BEGIN;
SELECT * FROM aircrafts_tmp WHERE range > 5000 FOR SHARE SKIP LOCKED;
-- Пропускает заблокированные строки, возвращая только доступные
```

## Сравнение с другими блокировками

| Команда          | Тип блокировки | Параллельное чтение | Параллельное изменение |
|------------------|----------------|---------------------|------------------------|
| `FOR SHARE`      | Совместная     | Разрешено           | Запрещено              |
| `FOR UPDATE`     | Исключительная | Запрещено           | Запрещено              |
| Без модификатора | Нет           | Разрешено           | Разрешено              |

## Когда использовать FOR SHARE?

1. **Чтение с последующим обновлением** - когда нужно гарантировать, что данные не изменятся до вашего обновления
2. **Согласованность отчетов** - для получения непротиворечивых данных в долгих отчетных транзакциях
3. **Оптимистичные блокировки** - в комбинации с проверкой версий данных

## Важные ограничения

1. Блокировки сохраняются до конца транзакции
2. Могут приводить к взаимоблокировкам (deadlocks)
3. Избыточное использование ухудшает параллелизм

## Документация

Для более глубокого изучения:
- [Официальная документация по SELECT](https://www.postgresql.org/docs/current/sql-select.html)
- [Блокировки в PostgreSQL](https://www.postgresql.org/docs/current/explicit-locking.html)
# Оптимальный уровень изоляции для операций бронирования билетов

## Анализ вариантов

### 1. **Read Committed (текущий подход)**
**Преимущества:**
- Высокая производительность и масштабируемость
- Минимальные блокировки, хорошая параллельность
- Подходит для большинства сценариев бронирования

**Недостатки:**
- Возможны редкие случаи "потерянных обновлений" (lost update)
- Риск перепродажи мест при высокой конкуренции

### 2. **Serializable уровень**
**Преимущества:**
- Гарантирует абсолютную согласованность
- Исключает любые аномалии параллельного доступа

**Недостатки:**
- Значительное снижение производительности (до 10-100 раз)
- Высокий риск взаимоблокировок (deadlocks)
- Частые отказы транзакций с ошибками сериализации

### 3. **Явные блокировки (FOR UPDATE)**
**Преимущества:**
- Точечный контроль над блокировками
- Сохраняет хорошую производительность
- Позволяет блокировать только критичные данные (места в самолете)

**Недостатки:**
- Требует аккуратного проектирования
- Увеличивает сложность кода

## Рекомендуемое решение

**Оптимальный подход:** комбинация **Read Committed** с **точечными блокировками** для критичных операций.

### Реализация:
```sql
BEGIN;
-- Блокируем только конкретное место при бронировании
SELECT * FROM seats 
WHERE aircraft_code = 'SU9' AND seat_no = '10A' 
FOR UPDATE;

-- Проверяем доступность
SELECT 1 FROM ticket_flights 
WHERE flight_id = 12345 AND seat_no = '10A' 
FOR UPDATE SKIP LOCKED;

-- Если место свободно, выполняем бронирование
INSERT INTO bookings (...) VALUES (...);
INSERT INTO tickets (...) VALUES (...);
INSERT INTO ticket_flights (...) VALUES (...);
COMMIT;
```

### Почему не Serializable:
1. Система бронирования должна поддерживать **высокую конкурентность**
2. **99% случаев** прекрасно работают на Read Committed
3. Ошибки сериализации потребуют **повтора транзакций**, что ухудшит UX

### Дополнительные меры:
1. **Оптимистичные блокировки** для сложных сценариев:
   ```sql
   UPDATE seats 
   SET version = version + 1 
   WHERE seat_id = 123 AND version = expected_version;
   ```
2. **Очередь обработки** для пиковых нагрузок
3. **Краткосрочные блокировки** (например, только на время выбора места)

## Вывод

Для системы бронирования авиабилетов **лучше сохранить Read Committed**, дополнив его **точечными блокировками критичных ресурсов** (мест в самолете). Полный Serializable избыточен и приведет к неоправданному падению производительности.
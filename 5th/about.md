Создание временных таблиц
• Используем предложение WITH NO DATA для создания временных таблиц.

Ограничения на временные таблицы
• Накладываем ограничения на aircrafts_tmp: первичный ключ (aircraft_code), уникальный ключ (model).
• Накладываем ограничения на aircrafts_log: добавляем столбцы when_add timestamp и operation text.

Вставка строк в таблицы
• Используем команду INSERT с общим табличным выражением для копирования данных из aircrafts в aircrafts_tmp.
• Вставляем строки в aircrafts_log с помощью SELECT из add_row.
• Проверяем результаты в обеих таблицах.

Обработка конфликтов
• Используем предложение ON CONFLICT для обработки конфликтов.
• Первый вариант: отмена добавления строки при конфликте.
• Второй вариант: замена вставки на обновление существующей строки.

Пример с ON CONFLICT
• Добавляем строку, конфликтующую с существующей по первичному и уникальному ключам.
• Проверяем, что строка не добавлена.
• Указываем конкретный столбец для проверки конфликта.
• Получаем сообщение об ошибке при нарушении уникальности.

Пример с DO UPDATE
• Добавляем предложение DO UPDATE для замены вставки на обновление.
• Проверяем, что при конфликте выполняется обновление существующей строки.
Вставка строк в таблицы
• В случае дублирования по атрибутам первичного ключа, обновляются значения всех остальных атрибутов.
• Пример: изменение значения атрибута model при сохранении значения range.
• Использование предложения ON CONFLICT DO UPDATE для атомарного выполнения операции.

Массовый ввод данных
• Команда COPY используется для копирования данных из файла в таблицу.
• Пример: добавление двух строк из файла в таблицу aircrafts_tmp.
• Команда COPY также может копировать данные из таблицы в файл.

Обновление строк в таблицах
• Команда UPDATE предназначена для обновления данных в таблицах.


Удаление строк из таблиц
• Запись операций в журнальную таблицу с помощью команды DELETE.
• Использование общего табличного выражения для записи в журнальную таблицу.
• Пример команды DELETE с использованием подзапроса и предложения USING.

Использование команды TRUNCATE
• Команда TRUNCATE для быстрого удаления всех строк из таблицы.
• Сравнение производительности команд DELETE и TRUNCATE.


# Краткий обзор основных команд модификации данных в PostgreSQL

## 1. **UPDATE** - обновление существующих строк
```sql
UPDATE table_name 
SET column1 = value1, column2 = value2, ...
[WHERE condition]
[RETURNING * | output_expression];
```
- Изменяет данные в существующих строках таблицы
- Без WHERE обновит все строки таблицы
- RETURNING возвращает обновленные строки

## 2. **DELETE** - удаление строк
```sql
DELETE FROM table_name 
[WHERE condition]
[RETURNING * | output_expression];
```
- Удаляет строки, соответствующие условию
- Без WHERE удалит все строки таблицы (но менее эффективно, чем TRUNCATE)
- RETURNING возвращает удаленные строки

## 3. **TRUNCATE** - быстрая очистка таблицы
```sql
TRUNCATE [TABLE] table_name 
[CASCADE | RESTRICT];
```
- Удаляет ВСЕ данные из таблицы быстрее, чем DELETE
- Сбрасывает последовательности (если есть)
- Не вызывает триггеры ON DELETE
- CASCADE также очищает зависимые таблицы

## 4. **COPY** - массовая загрузка/выгрузка данных
```sql
-- Импорт
COPY table_name [(column_list)] FROM '/path/to/file' [WITH (options)];

-- Экспорт 
COPY table_name [(column_list)] TO '/path/to/file' [WITH (options)];
```
- Быстрая загрузка/выгрузка больших объемов данных
- Поддерживает форматы: text, csv, binary
- Может работать с STDIN/STDOUT

## 5. **INSERT** - добавление новых строк
```sql
INSERT INTO table_name [(columns)] 
VALUES (value1, value2, ...), ...
[ON CONFLICT conflict_target conflict_action]
[RETURNING * | output_expression];
```
- Добавляет новые строки в таблицу
- Может вставлять несколько строк за один вызов
- RETURNING возвращает вставленные строки

## 6. **ON CONFLICT** (UPSERT) - вставка или обновление
```sql
INSERT INTO table_name VALUES (...) 
ON CONFLICT (column_name) 
DO UPDATE SET column = EXCLUDED.column;

-- Или
ON CONFLICT ON CONSTRAINT constraint_name 
DO NOTHING;
```
- Обрабатывает конфликты при вставке (дубликаты ключей)
- `DO UPDATE` - обновляет существующую строку
- `DO NOTHING` - пропускает вставку при конфликте
- EXCLUDED - специальная таблица с данными из конфликтующей вставки
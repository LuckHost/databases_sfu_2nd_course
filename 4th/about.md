
## Дополнительные возможности команды SELECT
• Использование оператора LIKE для поиска шаблонов.
• Оператор NOT LIKE для исключения определенных значений.
• Использование символа подчеркивания для поиска строк определенной длины.
• Операторы для работы с регулярными выражениями POSIX.
• Предикаты сравнения, такие как BETWEEN, для задания диапазонов.
• Вычисление и получение вычисляемых столбцов с помощью ключевого слова AS.

### Упорядочение строк
• Использование предложения ORDER BY для упорядочения строк.
• Возможность задания как возрастающего, так и убывающего порядка сортировки.

### Работа с таблицей «Аэропорты»
• Использование ключевого слова DISTINCT для удаления повторяющихся значений.
• Сортировка строк по убыванию значений столбца с помощью ORDER BY DESC
• Ограничение числа строк с помощью LIMIT
• OFFSET - пропуск первых строк

### Условные выражения
• Использование CASE WHEN для вывода значений в зависимости от условий

```sql
ALTER TABLE seats
  ALTER COLUMN fare_conditions SET DATA TYPE integer
  USING ( 
      CASE 
        WHEN fare_conditions = 'Economy' THEN 1
        WHEN fare_conditions = 'Business' THEN 2
        ELSE 3
      END 
    );

```

### Соединения таблиц
• Соединение таблиц с помощью JOIN
```sql
SELECT s.seat_no, s.fare_conditions
  FROM seats s
  JOIN aircrafts a ON s.aircraft_code = a.aircraft_code
  WHERE a.model ~ '^Cessna'
  ORDER BY s.seat_no;
```

• Пример запроса с соединением таблиц seats и aircrafts
• Использование псевдонимов таблиц
• Формирование декартова произведения строк из обеих таблиц
• Условие соединения таблиц s.aircraft_code = a.aircraft_code

### Реляционные операции
• Результат реляционных операций — отношение
• Таблица airports используется дважды: для departure_airport и arrival_airport.
• Псевдонимы dep и arr указывают, из какой копии таблицы airports брать значения.
Эквивалентные способы соединения
• Перечисление имен таблиц в FROM с псевдонимами.
• Соединение на основе неравенства значений атрибутов.
• Использование предложения CROSS JOIN для явного декартова произведения.
Внешние соединения
• Левое внешнее соединение: LEFT OUTER JOIN.
• Правое внешнее соединение: RIGHT OUTER JOIN.
• Полное внешнее соединение: FULL OUTER JOIN.
Левое внешнее соединение
• Базовая таблица: aircrafts.
• Для каждой строки из aircrafts подбираются строки из routes.
• Если в routes нет соответствующей строки, результирующая строка формируется с NULL.
Правое внешнее соединение
• Базовая таблица: routes.
• Механизм получения результирующих строк аналогичен левому внешнему соединению.
• Правое внешнее соединение можно заменить левым, поменяв имена таблиц местами.
Полное внешнее соединение
• Включает строки из обеих таблиц.
• Строки из левой таблицы, для которых нет соответствующих строк в правой, включаются.
• Строки из правой таблицы, для которых нет соответствующих строк в левой, также включаются.

### Многотабличные запросы
• Включают три таблицы и более
• Пример: определение числа пассажиров, не пришедших на регистрацию

Пример запроса
• SELECT count( * ) FROM ( ticket_flights t JOIN flights f ON t.flight_id = f.flight_id ) LEFT OUTER JOIN boarding_passes b ON t.ticket_no = b.ticket_no AND t.flight_id = b.flight_id WHERE f.actual_departure IS NOT NULL AND b.flight_id IS NULL

Логический порядок соединения таблиц
• Подключение таблиц слева направо
• Использование круглых скобок для изменения порядка

Пример сложного запроса
• Выявление случаев несовпадения классов обслуживания
• Использование пяти таблиц: boarding_passes, ticket_flights, tickets, flights, seats

Виртуальные таблицы
• Использование ключевого слова VALUES для создания виртуальных таблиц
• Пример запроса для распределения бронирований по диапазонам сумм

Операции с множествами строк
• UNION: объединение множеств строк
• INTERSECT: пересечение множеств строк
• EXCEPT: разность множеств строк

Агрегатные функции
• Функции avg, max, min используются для расчета среднего, максимального и минимального значений по столбцу.
• Функция count подсчитывает количество строк в выборке.

Группировка строк
• Группировка строк выполняется с помощью предложения GROUP BY.
• Пример: подсчет маршрутов из Москвы в другие города.
• Пример: обобщение информации по частоте выполнения рейсов.

Условия в предложениях WHERE и HAVING
• Предложение WHERE сужает множество выбираемых строк.
• Предложение HAVING используется для включения в результирующее множество только строк, удовлетворяющих условию.

Оконные функции
• Оконные функции позволяют производить вычисления на множестве строк, логически связанных с текущей строкой.
• Используются концепции раздела и оконного кадра.
• Пример: подсчет количества проданных билетов по месяцам.

Синтаксис оконных функций
• Ключевое слово OVER превращает обычную агрегатную функцию в оконную.
• Предложение PARTITION BY задает правило разбиения строк на разделы.
• Предложение ORDER BY предписывает порядок сортировки строк в разделах.

ORDER BY при формировании раздела
• Границы оконного кадра определяются по умолчанию
• Для указания границ предусмотрены различные способы
• Оконные функции могут применяться в качестве агрегатных

Оконные функции
• Оконные функции не требуют группировки строк
• Работают на уровне отдельных строк
• Вызываются после GROUP BY и HAVING

Пример использования rank
• Ранжирование аэропортов по географической широте
• Использование предложения OVER для указания порядка сортировки

Пример с WINDOW
• Создание определения раздела для оконных функций
• Использование функции first_value для выбора самого северного аэропорта

Подзапросы
• Команда SELECT работает на логическом уровне
• Подзапросы могут присутствовать в различных предложениях
• Скалярные подзапросы возвращают одно значение
• Некоррелированные подзапросы выполняются один раз для всего запроса

Пример с маршрутами
• Поиск маршрутов между городами часового пояса Asia/Krasnoyarsk
• Использование предиката IN для проверки принадлежности городов

Пример с крайними аэропортами
• Поиск самого западного и самого восточного аэропортов
• Использование скалярных подзапросов для формирования множества значений

Использование подзапросов
• Подзапросы позволяют выполнять сложные вычисления и анализировать данные.
• Подзапросы могут быть коррелированными, что означает выполнение для каждой строки внешнего запроса.

Примеры использования подзапросов
• Запрос для определения городов без рейсов из Москвы.
• Запрос для подсчета мест в самолетах разных классов.
• Запрос для получения перечня аэропортов в городах с более чем одним аэропортом.
• Запрос для определения числа маршрутов из аэропортов восточнее 150° долготы.

Вложенные подзапросы
• Вложенные подзапросы позволяют выполнять сложные вычисления внутри других подзапросов.
• Пример запроса для вычисления степени заполнения самолетов на рейсах.
Коррелированные подзапросы
• Коррелированные подзапросы выполняются для каждой строки внешнего запроса.
• Пример использования коррелированного подзапроса для подсчета мест в самолете.

Использование общих табличных выражений (CTE)
• CTE позволяют упростить сложные запросы, выделяя подзапросы в отдельные конструкции.
• В CTE может быть несколько подзапросов, каждый из которых формирует временную таблицу.
• Временные таблицы существуют только во время выполнения запроса.

Пример использования CTE
• Запрос для вычисления степени заполнения самолета пассажирами.
• Вычисление степени заполнения производится на основе количества пассажиров и общего количества мест.
• Сортировка результирующих строк по времени отправления.

Рекурсивные CTE
• Рекурсивные CTE позволяют формировать диапазоны значений.
• В примере используется рекурсивный алгоритм для формирования диапазонов сумм бронирований.
• Рекурсивный алгоритм работает путем добавления 100 тысяч рублей к предыдущему значению.

Пример комбинирования CTE и выборки
• Комбинированный запрос для выборки из таблицы bookings и использования CTE.
• Внешнее соединение используется для вывода строк с нулевыми значениями.

Пример создания материализованного представления
• Команда для создания материализованного представления "Маршруты".
• Вложенный подзапрос для вычисления длительности полета и извлечения номера дня недели.
• Группировка строк для замены дубликатов дней недели одним значением.

Агрегация номеров дней недели
• В таблицу flights включен столбец days_of_week
• Функция array_agg собирает номера дней недели в массив в возрастающем порядке

Формирование массива дней недели
• Функция array_agg агрегирует номера дней недели в массивы целых чисел
• Конструкция WITH f3 AS (...) завершает работу
